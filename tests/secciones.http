### ============================================================================
### PRUEBAS COMPLETAS - SISTEMA DE SECCIONES - SIGESDA
### ============================================================================
### Este archivo contiene pruebas end-to-end para el sistema de secciones
### Ejecutar en orden para validar toda la funcionalidad
### ============================================================================

@baseUrl = http://localhost:8000/api

### Variables para usar en las pruebas
# Estas se actualizarán automáticamente con las respuestas
@actividadId = cmfzndnt5000n4z6ckovxt5np
@seccionId =
@horarioId =
@docenteId =
@personaId =
@participacionId =
@aulaId =
@reservaId =

###############################################################################
### PARTE 1: CRUD DE SECCIONES
###############################################################################

### 1.1 Listar secciones existentes (migradas automáticamente)
# @name listarSecciones
GET {{baseUrl}}/secciones
Content-Type: application/json

### 1.2 Listar secciones con filtros y paginación
GET {{baseUrl}}/secciones?activa=true&page=1&limit=5

### 1.3 Buscar secciones por texto
GET {{baseUrl}}/secciones?search=Principal

### 1.4 Obtener sección por ID
GET {{baseUrl}}/secciones/{{seccionId}}

### 1.5 Obtener sección detallada (con todas las relaciones)
GET {{baseUrl}}/secciones/{{seccionId}}?detallada=true

### 1.6 Crear nueva sección completa
# @name crearSeccion
POST {{baseUrl}}/secciones
Content-Type: application/json

{
  "actividadId": "{{actividadId}}",
  "nombre": "Grupo A - Mañana",
  "codigo": "PIANO-MA-A",
  "capacidadMaxima": 8,
  "observaciones": "Grupo para nivel principiante",
  "horarios": [
    {
      "diaSemana": "LUNES",
      "horaInicio": "09:00",
      "horaFin": "10:30"
    },
    {
      "diaSemana": "MIERCOLES",
      "horaInicio": "09:00",
      "horaFin": "10:30"
    }
  ]
}

### 1.7 Crear sección con docentes
POST {{baseUrl}}/secciones
Content-Type: application/json

{
  "actividadId": "{{actividadId}}",
  "nombre": "Grupo B - Tarde",
  "codigo": "PIANO-TA-B",
  "capacidadMaxima": 6,
  "docenteIds": ["{{docenteId}}"],
  "horarios": [
    {
      "diaSemana": "MARTES",
      "horaInicio": "16:00",
      "horaFin": "17:30"
    },
    {
      "diaSemana": "JUEVES",
      "horaInicio": "16:00",
      "horaFin": "17:30"
    }
  ]
}

### 1.8 Intentar crear sección con nombre duplicado (debe fallar)
# Expected: 400 Bad Request
POST {{baseUrl}}/secciones
Content-Type: application/json

{
  "actividadId": "{{actividadId}}",
  "nombre": "Grupo A - Mañana",
  "codigo": "PIANO-MA-A2"
}

### 1.9 Actualizar sección
PUT {{baseUrl}}/secciones/{{seccionId}}
Content-Type: application/json

{
  "nombre": "Grupo A - Mañana Modificado",
  "capacidadMaxima": 10,
  "observaciones": "Actualizado para mayor capacidad"
}

### 1.10 Desactivar sección
PUT {{baseUrl}}/secciones/{{seccionId}}
Content-Type: application/json

{
  "activa": false
}

### 1.11 Reactivar sección
PUT {{baseUrl}}/secciones/{{seccionId}}
Content-Type: application/json

{
  "activa": true
}

###############################################################################
### PARTE 2: GESTIÓN DE HORARIOS
###############################################################################

### 2.1 Agregar horario a sección existente
# @name agregarHorario
POST {{baseUrl}}/secciones/{{seccionId}}/horarios
Content-Type: application/json

{
  "diaSemana": "VIERNES",
  "horaInicio": "14:00",
  "horaFin": "15:30"
}

### 2.2 Intentar agregar horario solapado (debe fallar)
# Expected: 400 Bad Request - Conflicto de horarios
POST {{baseUrl}}/secciones/{{seccionId}}/horarios
Content-Type: application/json

{
  "diaSemana": "LUNES",
  "horaInicio": "09:30",
  "horaFin": "11:00"
}

### 2.3 Actualizar horario
PUT {{baseUrl}}/secciones/horarios/{{horarioId}}
Content-Type: application/json

{
  "horaInicio": "14:30",
  "horaFin": "16:00"
}

### 2.4 Desactivar horario
PUT {{baseUrl}}/secciones/horarios/{{horarioId}}
Content-Type: application/json

{
  "activo": false
}

### 2.5 Eliminar horario
DELETE {{baseUrl}}/secciones/horarios/{{horarioId}}

###############################################################################
### PARTE 3: GESTIÓN DE DOCENTES
###############################################################################

### 3.1 Listar docentes disponibles
GET {{baseUrl}}/personas?tipo=DOCENTE

### 3.2 Asignar docente a sección
POST {{baseUrl}}/secciones/{{seccionId}}/docentes
Content-Type: application/json

{
  "docenteId": "{{docenteId}}"
}

### 3.3 Intentar asignar mismo docente (debe fallar)
# Expected: 400 Bad Request - Docente ya asignado
POST {{baseUrl}}/secciones/{{seccionId}}/docentes
Content-Type: application/json

{
  "docenteId": "{{docenteId}}"
}

### 3.4 Intentar asignar docente con conflicto de horarios (debe fallar)
# Expected: 400 Bad Request - Conflicto de horarios
POST {{baseUrl}}/secciones/{{seccionId}}/docentes
Content-Type: application/json

{
  "docenteId": "otro_docente_con_conflicto"
}

### 3.5 Remover docente de sección
DELETE {{baseUrl}}/secciones/{{seccionId}}/docentes/{{docenteId}}

### 3.6 Ver carga horaria del docente
GET {{baseUrl}}/personas/docentes/{{docenteId}}/carga-horaria

###############################################################################
### PARTE 4: GESTIÓN DE PARTICIPACIONES
###############################################################################

### 4.1 Listar personas disponibles para inscripción
GET {{baseUrl}}/personas?tipo=SOCIO&limit=5

### 4.2 Inscribir participante en sección
# @name inscribirParticipante
POST {{baseUrl}}/secciones/{{seccionId}}/participantes
Content-Type: application/json

{
  "personaId": "{{personaId}}",
  "fechaInicio": "2025-01-15T00:00:00Z",
  "precioEspecial": 4500,
  "observaciones": "Descuento por socio activo"
}

### 4.3 Intentar inscribir misma persona (debe fallar)
# Expected: 400 Bad Request - Persona ya inscrita
POST {{baseUrl}}/secciones/{{seccionId}}/participantes
Content-Type: application/json

{
  "personaId": "{{personaId}}",
  "fechaInicio": "2025-01-15T00:00:00Z"
}

### 4.4 Listar participantes de la sección
GET {{baseUrl}}/secciones/{{seccionId}}/participantes

### 4.5 Listar solo participantes activos
GET {{baseUrl}}/secciones/{{seccionId}}/participantes?activas=true

### 4.6 Listar todas las participaciones (activas e inactivas)
GET {{baseUrl}}/secciones/{{seccionId}}/participantes?activas=false

### 4.7 Listar secciones de una persona
GET {{baseUrl}}/personas/{{personaId}}/secciones

### 4.8 Actualizar participación
PUT {{baseUrl}}/secciones/participaciones/{{participacionId}}
Content-Type: application/json

{
  "precioEspecial": 4000,
  "observaciones": "Descuento adicional aplicado"
}

### 4.9 Dar de baja participación
POST {{baseUrl}}/secciones/participaciones/{{participacionId}}/baja
Content-Type: application/json

{
  "fechaFin": "2025-06-30T00:00:00Z"
}

### 4.10 Intentar inscribir en sección con capacidad llena (crear setup primero)
# Para probar: crear sección con capacidad 1, inscribir 1 persona, intentar inscribir otra
POST {{baseUrl}}/secciones
Content-Type: application/json

{
  "actividadId": "{{actividadId}}",
  "nombre": "Grupo Prueba Capacidad",
  "capacidadMaxima": 1,
  "horarios": [
    {
      "diaSemana": "SABADO",
      "horaInicio": "10:00",
      "horaFin": "11:00"
    }
  ]
}

###############################################################################
### PARTE 5: GESTIÓN DE RESERVAS DE AULAS
###############################################################################

### 5.1 Listar aulas disponibles
GET {{baseUrl}}/aulas?activa=true

### 5.2 Crear reserva de aula para sección
# @name crearReserva
POST {{baseUrl}}/secciones/{{seccionId}}/reservas-aulas
Content-Type: application/json

{
  "aulaId": "{{aulaId}}",
  "diaSemana": "LUNES",
  "horaInicio": "09:00",
  "horaFin": "10:30",
  "fechaVigencia": "2025-01-15T00:00:00Z",
  "observaciones": "Reserva para todo el semestre"
}

### 5.3 Intentar crear reserva con aula ocupada (debe fallar)
# Expected: 400 Bad Request - Aula ya reservada
POST {{baseUrl}}/secciones/{{seccionId}}/reservas-aulas
Content-Type: application/json

{
  "aulaId": "{{aulaId}}",
  "diaSemana": "LUNES",
  "horaInicio": "09:30",
  "horaFin": "11:00",
  "fechaVigencia": "2025-01-15T00:00:00Z"
}

### 5.4 Actualizar reserva de aula
PUT {{baseUrl}}/secciones/reservas-aulas/{{reservaId}}
Content-Type: application/json

{
  "fechaFin": "2025-06-30T00:00:00Z",
  "observaciones": "Actualizada fecha de fin"
}

### 5.5 Eliminar reserva de aula
DELETE {{baseUrl}}/secciones/reservas-aulas/{{reservaId}}

###############################################################################
### PARTE 6: VALIDACIONES Y VERIFICACIÓN DE CONFLICTOS
###############################################################################

### 6.1 Verificar conflictos de docente
POST {{baseUrl}}/secciones/verificar-conflictos
Content-Type: application/json

{
  "diaSemana": "LUNES",
  "horaInicio": "09:00",
  "horaFin": "10:30",
  "docenteId": "{{docenteId}}"
}

### 6.2 Verificar conflictos de aula
POST {{baseUrl}}/secciones/verificar-conflictos
Content-Type: application/json

{
  "diaSemana": "LUNES",
  "horaInicio": "09:00",
  "horaFin": "10:30",
  "aulaId": "{{aulaId}}"
}

### 6.3 Verificar conflictos de docente y aula simultáneamente
POST {{baseUrl}}/secciones/verificar-conflictos
Content-Type: application/json

{
  "diaSemana": "MARTES",
  "horaInicio": "14:00",
  "horaFin": "15:30",
  "docenteId": "{{docenteId}}",
  "aulaId": "{{aulaId}}"
}

### 6.4 Verificar sin conflictos (horario libre)
POST {{baseUrl}}/secciones/verificar-conflictos
Content-Type: application/json

{
  "diaSemana": "DOMINGO",
  "horaInicio": "08:00",
  "horaFin": "09:00",
  "docenteId": "{{docenteId}}",
  "aulaId": "{{aulaId}}"
}

###############################################################################
### PARTE 7: REPORTES Y ESTADÍSTICAS
###############################################################################

### 7.1 Obtener estadísticas de una sección
GET {{baseUrl}}/secciones/{{seccionId}}/estadisticas

### 7.2 Obtener horario semanal completo
GET {{baseUrl}}/secciones/horario-semanal

### 7.3 Obtener ocupación global de secciones
GET {{baseUrl}}/secciones/ocupacion

### 7.4 Obtener secciones de una actividad específica
GET {{baseUrl}}/actividades/{{actividadId}}/secciones

### 7.5 Obtener carga horaria de un docente
GET {{baseUrl}}/personas/docentes/{{docenteId}}/carga-horaria

###############################################################################
### PARTE 8: CASOS DE BORDE Y VALIDACIONES
###############################################################################

### 8.1 Crear sección sin horarios
POST {{baseUrl}}/secciones
Content-Type: application/json

{
  "actividadId": "{{actividadId}}",
  "nombre": "Grupo Sin Horarios",
  "codigo": "PIANO-SH"
}

### 8.2 Crear sección con horario inválido (horaFin < horaInicio)
# Expected: 400 Bad Request
POST {{baseUrl}}/secciones
Content-Type: application/json

{
  "actividadId": "{{actividadId}}",
  "nombre": "Grupo Horario Inválido",
  "horarios": [
    {
      "diaSemana": "LUNES",
      "horaInicio": "10:00",
      "horaFin": "09:00"
    }
  ]
}

### 8.3 Crear sección con código duplicado (debe fallar)
# Expected: 400 Bad Request
POST {{baseUrl}}/secciones
Content-Type: application/json

{
  "actividadId": "{{actividadId}}",
  "nombre": "Grupo Código Duplicado",
  "codigo": "PIANO-MA-A"
}

### 8.4 Intentar inscribir persona no existente
# Expected: 400 Bad Request
POST {{baseUrl}}/secciones/{{seccionId}}/participantes
Content-Type: application/json

{
  "personaId": "id_inexistente_12345",
  "fechaInicio": "2025-01-15T00:00:00Z"
}

### 8.5 Intentar asignar docente no existente
# Expected: 400 Bad Request
POST {{baseUrl}}/secciones/{{seccionId}}/docentes
Content-Type: application/json

{
  "docenteId": "id_inexistente_12345"
}

### 8.6 Intentar crear reserva con aula no existente
# Expected: 400 Bad Request
POST {{baseUrl}}/secciones/{{seccionId}}/reservas-aulas
Content-Type: application/json

{
  "aulaId": "id_inexistente_12345",
  "diaSemana": "LUNES",
  "horaInicio": "09:00",
  "horaFin": "10:30",
  "fechaVigencia": "2025-01-15T00:00:00Z"
}

### 8.7 Intentar eliminar sección con participantes activos
# Expected: 400 Bad Request - No se puede eliminar
DELETE {{baseUrl}}/secciones/{{seccionId}}

### 8.8 Actualizar sección con nombre que ya existe en la misma actividad
# Expected: 400 Bad Request
PUT {{baseUrl}}/secciones/{{seccionId}}
Content-Type: application/json

{
  "nombre": "Sección Principal"
}

###############################################################################
### PARTE 9: PRUEBAS DE INTEGRACIÓN COMPLETA
###############################################################################

### 9.1 Flujo completo: Crear actividad → Crear sección → Asignar docente → Inscribir alumnos

### 9.1.1 Crear actividad
# @name crearActividadTest
POST {{baseUrl}}/actividades
Content-Type: application/json

{
  "nombre": "Piano Nivel 2 - Test Integración",
  "tipo": "CLASE_INSTRUMENTO",
  "descripcion": "Clase de piano nivel intermedio",
  "precio": 6000,
  "capacidadMaxima": 10
}

### 9.1.2 Crear sección para la actividad
# @name crearSeccionTest
POST {{baseUrl}}/secciones
Content-Type: application/json

{
  "actividadId": "{{crearActividadTest.response.body.data.id}}",
  "nombre": "Grupo Mañana",
  "codigo": "PIANO-L2-MA",
  "capacidadMaxima": 5,
  "horarios": [
    {
      "diaSemana": "LUNES",
      "horaInicio": "10:00",
      "horaFin": "11:30"
    },
    {
      "diaSemana": "MIERCOLES",
      "horaInicio": "10:00",
      "horaFin": "11:30"
    }
  ]
}

### 9.1.3 Asignar docente a la sección
POST {{baseUrl}}/secciones/{{crearSeccionTest.response.body.data.id}}/docentes
Content-Type: application/json

{
  "docenteId": "{{docenteId}}"
}

### 9.1.4 Reservar aula para la sección
POST {{baseUrl}}/secciones/{{crearSeccionTest.response.body.data.id}}/reservas-aulas
Content-Type: application/json

{
  "aulaId": "{{aulaId}}",
  "diaSemana": "LUNES",
  "horaInicio": "10:00",
  "horaFin": "11:30",
  "fechaVigencia": "2025-01-15T00:00:00Z"
}

### 9.1.5 Inscribir participantes
POST {{baseUrl}}/secciones/{{crearSeccionTest.response.body.data.id}}/participantes
Content-Type: application/json

{
  "personaId": "{{personaId}}",
  "fechaInicio": "2025-01-15T00:00:00Z"
}

### 9.1.6 Ver estadísticas de la sección
GET {{baseUrl}}/secciones/{{crearSeccionTest.response.body.data.id}}/estadisticas

### 9.1.7 Ver en horario semanal
GET {{baseUrl}}/secciones/horario-semanal

###############################################################################
### PARTE 10: LIMPIEZA Y VALIDACIÓN FINAL
###############################################################################

### 10.1 Verificar integridad: todas las secciones tienen actividad
GET {{baseUrl}}/secciones

### 10.2 Verificar que no hay conflictos en el horario semanal
GET {{baseUrl}}/secciones/horario-semanal

### 10.3 Verificar ocupación global
GET {{baseUrl}}/secciones/ocupacion

### 10.4 Dar de baja todas las participaciones de prueba
POST {{baseUrl}}/secciones/participaciones/{{participacionId}}/baja

### 10.5 Desactivar secciones de prueba
PUT {{baseUrl}}/secciones/{{seccionId}}
Content-Type: application/json

{
  "activa": false
}

###############################################################################
### FIN DE PRUEBAS
###############################################################################

### RESUMEN DE PRUEBAS:
### ✅ CRUD de secciones (11 tests)
### ✅ Gestión de horarios (5 tests)
### ✅ Gestión de docentes (6 tests)
### ✅ Gestión de participaciones (10 tests)
### ✅ Gestión de reservas de aulas (5 tests)
### ✅ Validaciones y conflictos (4 tests)
### ✅ Reportes y estadísticas (5 tests)
### ✅ Casos de borde (8 tests)
### ✅ Integración completa (7 tests)
### ✅ Validación final (5 tests)
###
### TOTAL: 66 pruebas

### NOTAS:
### - Actualizar las variables @actividadId, @docenteId, @personaId, @aulaId
###   con IDs reales de tu base de datos antes de ejecutar
### - Ejecutar en orden para validaciones de dependencias
### - Algunas pruebas deben fallar intencionalmente (marcadas con Expected)

### ============================================================================
### TESTS - WORKFLOW DE RESERVAS DE AULAS
### ============================================================================
### Base URL
@baseUrl = http://localhost:8000/api
@reservasUrl = {{baseUrl}}/reservas

### Variables
@contentType = application/json

### Variables dinámicas (actualizar después de crear)
@reservaId = 1
@personaId = 1
@aulaId = 1
@docenteId = 1

### ============================================================================
### PREPARACIÓN - CREAR RESERVA DE PRUEBA
### ============================================================================

### 0.1. Crear reserva de prueba (estado inicial: PENDIENTE)
POST {{reservasUrl}}
Content-Type: {{contentType}}

{
  "aulaId": {{aulaId}},
  "docenteId": {{docenteId}},
  "fechaInicio": "2025-12-01T10:00:00.000Z",
  "fechaFin": "2025-12-01T12:00:00.000Z",
  "observaciones": "Reserva de prueba para testing de workflow"
}

### 0.2. Verificar reserva creada
GET {{reservasUrl}}/{{reservaId}}
Content-Type: {{contentType}}

### ============================================================================
### 1. APROBAR RESERVA (PENDIENTE -> CONFIRMADA)
### ============================================================================

### 1.1. Aprobar reserva con persona válida
POST {{reservasUrl}}/{{reservaId}}/aprobar
Content-Type: {{contentType}}

{
  "aprobadoPorId": {{personaId}},
  "observaciones": "Reserva aprobada por coordinación"
}

### 1.2. Intentar aprobar reserva ya aprobada (ERROR esperado)
POST {{reservasUrl}}/{{reservaId}}/aprobar
Content-Type: {{contentType}}

{
  "aprobadoPorId": {{personaId}}
}

### 1.3. Intentar aprobar sin persona (ERROR esperado)
POST {{reservasUrl}}/{{reservaId}}/aprobar
Content-Type: {{contentType}}

{}

### ============================================================================
### 2. RECHAZAR RESERVA (PENDIENTE -> RECHAZADA)
### ============================================================================

### 2.1. Crear nueva reserva para rechazar
POST {{reservasUrl}}
Content-Type: {{contentType}}

{
  "aulaId": {{aulaId}},
  "docenteId": {{docenteId}},
  "fechaInicio": "2025-12-02T14:00:00.000Z",
  "fechaFin": "2025-12-02T16:00:00.000Z",
  "observaciones": "Reserva para testing de rechazo"
}

### 2.2. Rechazar reserva con motivo
POST {{reservasUrl}}/2/rechazar
Content-Type: {{contentType}}

{
  "rechazadoPorId": {{personaId}},
  "motivo": "El aula requiere mantenimiento en esa fecha"
}

### 2.3. Intentar rechazar sin motivo (ERROR esperado)
POST {{reservasUrl}}/2/rechazar
Content-Type: {{contentType}}

{
  "rechazadoPorId": {{personaId}}
}

### ============================================================================
### 3. CANCELAR RESERVA (PENDIENTE/CONFIRMADA -> CANCELADA)
### ============================================================================

### 3.1. Cancelar reserva PENDIENTE
POST {{reservasUrl}}/{{reservaId}}/cancelar
Content-Type: {{contentType}}

{
  "canceladoPorId": {{personaId}},
  "motivoCancelacion": "El docente solicitó cancelar la reserva por enfermedad"
}

### 3.2. Crear y aprobar reserva para cancelarla después
POST {{reservasUrl}}
Content-Type: {{contentType}}

{
  "aulaId": {{aulaId}},
  "docenteId": {{docenteId}},
  "fechaInicio": "2025-12-03T09:00:00.000Z",
  "fechaFin": "2025-12-03T11:00:00.000Z"
}

### 3.3. Aprobar la reserva creada
POST {{reservasUrl}}/3/aprobar
Content-Type: {{contentType}}

{
  "aprobadoPorId": {{personaId}}
}

### 3.4. Cancelar reserva CONFIRMADA
POST {{reservasUrl}}/3/cancelar
Content-Type: {{contentType}}

{
  "canceladoPorId": {{personaId}},
  "motivoCancelacion": "Cambio de fecha solicitado por el departamento"
}

### ============================================================================
### 4. COMPLETAR RESERVA (CONFIRMADA -> COMPLETADA)
### ============================================================================

### 4.1. Crear reserva en el pasado para completar
POST {{reservasUrl}}
Content-Type: {{contentType}}

{
  "aulaId": {{aulaId}},
  "docenteId": {{docenteId}},
  "fechaInicio": "2024-11-20T10:00:00.000Z",
  "fechaFin": "2024-11-20T12:00:00.000Z",
  "observaciones": "Reserva pasada para testing de completar"
}

### 4.2. Aprobar la reserva
POST {{reservasUrl}}/4/aprobar
Content-Type: {{contentType}}

{
  "aprobadoPorId": {{personaId}}
}

### 4.3. Completar la reserva
POST {{reservasUrl}}/4/completar
Content-Type: {{contentType}}

### 4.4. Intentar completar reserva futura (ERROR esperado)
POST {{reservasUrl}}/{{reservaId}}/completar
Content-Type: {{contentType}}

### ============================================================================
### 5. DETECTAR CONFLICTOS COMPLETOS (Puntuales + Recurrentes)
### ============================================================================

### 5.1. Detectar todos los conflictos para un horario
POST {{reservasUrl}}/conflicts/detect-all
Content-Type: {{contentType}}

{
  "aulaId": {{aulaId}},
  "fechaInicio": "2025-12-01T10:00:00.000Z",
  "fechaFin": "2025-12-01T12:00:00.000Z"
}

### 5.2. Detectar conflictos excluyendo una reserva
POST {{reservasUrl}}/conflicts/detect-all
Content-Type: {{contentType}}

{
  "aulaId": {{aulaId}},
  "fechaInicio": "2025-12-01T10:00:00.000Z",
  "fechaFin": "2025-12-01T12:00:00.000Z",
  "excludeReservaId": {{reservaId}}
}

### ============================================================================
### 6. LISTAR RESERVAS POR ESTADO
### ============================================================================

### 6.1. Listar todas las reservas activas
GET {{reservasUrl}}?soloActivas=true
Content-Type: {{contentType}}

### 6.2. Listar reservas por estado específico (PENDIENTE = 1)
GET {{reservasUrl}}?estadoReservaId=1
Content-Type: {{contentType}}

### 6.3. Listar reservas confirmadas (CONFIRMADA = 2)
GET {{reservasUrl}}?estadoReservaId=2
Content-Type: {{contentType}}

### 6.4. Listar todas las reservas (activas e inactivas)
GET {{reservasUrl}}?soloActivas=false
Content-Type: {{contentType}}

### ============================================================================
### 7. CASOS DE ERROR - TRANSICIONES INVÁLIDAS
### ============================================================================

### 7.1. Intentar completar reserva PENDIENTE (ERROR esperado)
POST {{reservasUrl}}/{{reservaId}}/completar
Content-Type: {{contentType}}

### 7.2. Intentar aprobar reserva COMPLETADA (ERROR esperado)
POST {{reservasUrl}}/4/aprobar
Content-Type: {{contentType}}

{
  "aprobadoPorId": {{personaId}}
}

### 7.3. Intentar rechazar reserva CONFIRMADA (ERROR esperado)
POST {{reservasUrl}}/3/rechazar
Content-Type: {{contentType}}

{
  "rechazadoPorId": {{personaId}},
  "motivo": "Esto no debería funcionar"
}

### ============================================================================
### 8. VALIDACIONES DE NEGOCIO
### ============================================================================

### 8.1. Intentar crear reserva con persona inactiva (ERROR esperado)
POST {{reservasUrl}}
Content-Type: {{contentType}}

{
  "aulaId": {{aulaId}},
  "docenteId": 999,
  "fechaInicio": "2025-12-10T10:00:00.000Z",
  "fechaFin": "2025-12-10T12:00:00.000Z"
}

### 8.2. Intentar aprobar con persona inactiva (ERROR esperado)
POST {{reservasUrl}}/{{reservaId}}/aprobar
Content-Type: {{contentType}}

{
  "aprobadoPorId": 999
}

### 8.3. Intentar crear reserva con conflicto de horario
POST {{reservasUrl}}
Content-Type: {{contentType}}

{
  "aulaId": {{aulaId}},
  "docenteId": {{docenteId}},
  "fechaInicio": "2025-12-01T10:30:00.000Z",
  "fechaFin": "2025-12-01T11:30:00.000Z",
  "observaciones": "Esta debería generar conflicto"
}
